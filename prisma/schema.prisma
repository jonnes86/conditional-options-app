// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id          String   @id @db.VarChar(255)
  shop        String   @db.VarChar(255)
  state       String   @db.VarChar(255)
  isOnline    Boolean  @default(false)
  scope       String?  @db.VarChar(255)
  expires     DateTime?
  accessToken String?  @db.Text
  userId      BigInt?

  @@index([shop])
}

model OptionTemplate {
  id          String   @id @default(cuid())
  shop        String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  options     Option[]
  rules       Rule[]
  products    ProductTemplate[]

  @@index([shop])
}

model Option {
  id         String   @id @default(cuid())
  templateId String
  name       String
  position   Int
  createdAt  DateTime @default(now())

  template   OptionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  values     OptionValue[]
  rulesFrom  Rule[]         @relation("FromOption")
  rulesTo    Rule[]         @relation("ToOption")

  @@index([templateId])
}

model OptionValue {
  id        String   @id @default(cuid())
  optionId  String
  value     String
  label     String?
  position  Int
  createdAt DateTime @default(now())

  option       Option @relation(fields: [optionId], references: [id], onDelete: Cascade)
  rulesFrom    Rule[] @relation("FromValue")
  allowedRules Rule[] @relation("AllowedValue")

  @@index([optionId])
}

model Rule {
  id                String      @id @default(cuid())
  templateId        String
  fromOptionId      String
  fromValueId       String
  toOptionId        String
  createdAt         DateTime    @default(now())

  template          OptionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  fromOption        Option         @relation("FromOption", fields: [fromOptionId], references: [id], onDelete: Cascade)
  fromValue         OptionValue    @relation("FromValue", fields: [fromValueId], references: [id], onDelete: Cascade)
  toOption          Option         @relation("ToOption", fields: [toOptionId], references: [id], onDelete: Cascade)
  allowedValues     OptionValue[]  @relation("AllowedValue")

  @@index([templateId])
  @@index([fromOptionId, fromValueId])
}

model ProductTemplate {
  id         String   @id @default(cuid())
  shop       String
  productId  String
  templateId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  template   OptionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([shop, productId])
  @@index([shop])
}
